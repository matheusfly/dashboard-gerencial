<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Management System - Client Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#1d4ed8',
                        accent: '#3b82f6',
                        dark: '#1e293b'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 25px;
        }
        .canvas-container {
            position: relative;
            width: 100%;
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        canvas {
            background: #f8fafc;
            width: 100%;
            height: 100%;
        }
        .controls {
            padding: 20px;
            background: #f1f5f9;
            border-top: 1px solid #e2e8f0;
        }
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .control-item {
            flex: 1;
            min-width: 200px;
        }
        .control-item label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #475569;
        }
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .btn {
            background: linear-gradient(to right, #1e40af, #1d4ed8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
            background: linear-gradient(to right, #1d4ed8, #1e40af);
        }
        .btn i {
            margin-right: 8px;
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-upload {
            background: linear-gradient(to right, #047857, #065f46);
        }
        .btn-upload:hover {
            background: linear-gradient(to right, #065f46, #047857);
            box-shadow: 0 4px 12px rgba(4, 120, 87, 0.3);
        }
        .file-input {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #f1f5f9;
            border-top: 1px solid #e2e8f0;
            font-size: 14px;
            color: #475569;
        }
        .status-item {
            display: flex;
            align-items: center;
        }
        .status-item i {
            margin-right: 6px;
            color: #3b82f6;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            display: none;
            z-index: 100;
            max-width: 300px;
            line-height: 1.4;
        }
        .tooltip:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
            color: #1e40af;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.95rem;
        }
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        .icon-clients {
            background: rgba(30, 64, 175, 0.1);
            color: #1e40af;
        }
        .icon-contracts {
            background: rgba(16, 185, 129, 0.1);
            color: #16a34a;
        }
        .icon-revenue {
            background: rgba(234, 179, 8, 0.1);
            color: #d97706;
        }
        .icon-churn {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: linear-gradient(to right, #047857, #065f46);
        }
        .notification.error {
            background: linear-gradient(to right, #b91c1c, #991b1b);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-dumbbell"></i> Gym Business Intelligence Dashboard</h1>
            <p>Análise avançada de dados para gestão estratégica de academias</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon icon-clients">
                    <i class="fas fa-users fa-2x"></i>
                </div>
                <div class="stat-label">Clientes Ativos</div>
                <div class="stat-value" id="active-clients">0</div>
                <div class="stat-trend">↑ 5.2% em relação ao mês passado</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-contracts">
                    <i class="fas fa-file-contract fa-2x"></i>
                </div>
                <div class="stat-label">Contratos Ativos</div>
                <div class="stat-value" id="active-contracts">0</div>
                <div class="stat-trend">↑ 3.8% em relação ao mês passado</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-revenue">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
                <div class="stat-label">Receita Mensal</div>
                <div class="stat-value" id="monthly-revenue">R$ 0</div>
                <div class="stat-trend">↑ 7.1% em relação ao mês passado</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-churn">
                    <i class="fas fa-user-slash fa-2x"></i>
                </div>
                <div class="stat-label">Taxa de Churn</div>
                <div class="stat-value" id="churn-rate">0%</div>
                <div class="stat-trend">↓ 0.8% em relação ao mês passado</div>
            </div>
        </div>

        <div class="card">
            <div class="tab-container">
                <div class="tab active" data-tab="overview">Visão Geral</div>
                <div class="tab" data-tab="clients">Clientes</div>
                <div class="tab" data-tab="contracts">Contratos</div>
                <div class="tab" data-tab="revenue">Receita</div>
                <div class="tab" data-tab="churn">Churn Analysis</div>
            </div>
            
            <div class="canvas-container">
                <canvas id="analyticsCanvas"></canvas>
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <div>Processando dados...</div>
                </div>
                <div class="tooltip" id="canvasTooltip"></div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <div class="control-item">
                        <label for="fileClients">Carregar Clientes (clientes.xlsx)</label>
                        <button class="btn btn-upload" id="btnUploadClients">
                            <i class="fas fa-upload"></i> Selecionar Arquivo
                        </button>
                        <input type="file" class="file-input" id="fileClients" accept=".xlsx, .xls">
                        <div class="file-name" id="fileNameClients">Nenhum arquivo selecionado</div>
                    </div>
                    <div class="control-item">
                        <label for="fileFluxo">Carregar Fluxo de Caixa (fluxo_caixa.xlsx)</label>
                        <button class="btn btn-upload" id="btnUploadFluxo">
                            <i class="fas fa-upload"></i> Selecionar Arquivo
                        </button>
                        <input type="file" class="file-input" id="fileFluxo" accept=".xlsx, .xls">
                        <div class="file-name" id="fileNameFluxo">Nenhum arquivo selecionado</div>
                    </div>
                    <div class="control-item">
                        <label for="fileFunil">Carregar Funil de Vendas (funil_vendas.xlsx)</label>
                        <button class="btn btn-upload" id="btnUploadFunil">
                            <i class="fas fa-upload"></i> Selecionar Arquivo
                        </button>
                        <input type="file" class="file-input" id="fileFunil" accept=".xlsx, .xls">
                        <div class="file-name" id="fileNameFunil">Nenhum arquivo selecionado</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-item">
                        <label for="searchQuery">Buscar Clientes</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="searchQuery" placeholder="Nome, CPF, código ou telefone...">
                            <button class="btn" id="btnSearch">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    <div class="control-item">
                        <label for="viewType">Visualização</label>
                        <select id="viewType">
                            <option value="overview">Visão Geral</option>
                            <option value="clients">Clientes</option>
                            <option value="contracts">Contratos</option>
                            <option value="revenue">Receita</option>
                            <option value="churn">Churn Analysis</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label for="timeRange">Período</label>
                        <select id="timeRange">
                            <option value="7d">Últimos 7 dias</option>
                            <option value="30d" selected>Últimos 30 dias</option>
                            <option value="90d">Últimos 90 dias</option>
                            <option value="1y">Último ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <i class="fas fa-database"></i> Dados carregados: <span id="dataStatus">Nenhum arquivo</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-sync"></i> Última atualização: <span id="lastUpdate">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Armazenamento dos dados
        let clientData = null;
        let contractData = null;
        let salesFunnelData = null;
        let revenueData = null;
        
        // Configuração do canvas
        const canvas = document.getElementById('analyticsCanvas');
        const ctx = canvas.getContext('2d');
        let currentView = 'overview';
        let timeRange = '30d';
        
        // Elementos da UI
        const fileClients = document.getElementById('fileClients');
        const fileFluxo = document.getElementById('fileFluxo');
        const fileFunil = document.getElementById('fileFunil');
        const fileNameClients = document.getElementById('fileNameClients');
        const fileNameFluxo = document.getElementById('fileNameFluxo');
        const fileNameFunil = document.getElementById('fileNameFunil');
        const btnUploadClients = document.getElementById('btnUploadClients');
        const btnUploadFluxo = document.getElementById('btnUploadFluxo');
        const btnUploadFunil = document.getElementById('btnUploadFunil');
        const btnSearch = document.getElementById('btnSearch');
        const searchQuery = document.getElementById('searchQuery');
        const viewType = document.getElementById('viewType');
        const timeRangeSelect = document.getElementById('timeRange');
        const tabElements = document.querySelectorAll('.tab');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const canvasTooltip = document.getElementById('canvasTooltip');
        const notification = document.getElementById('notification');
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Ajustar tamanho do canvas
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Event listeners para uploads
            btnUploadClients.addEventListener('click', () => fileClients.click());
            btnUploadFluxo.addEventListener('click', () => fileFluxo.click());
            btnUploadFunil.addEventListener('click', () => fileFunil.click());
            
            // Event listeners para seleção de arquivos
            fileClients.addEventListener('change', handleFileSelect('clients'));
            fileFluxo.addEventListener('change', handleFileSelect('fluxo'));
            fileFunil.addEventListener('change', handleFileSelect('funil'));
            
            // Event listeners para busca
            btnSearch.addEventListener('click', performSearch);
            searchQuery.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            
            // Event listeners para mudanças de visualização
            viewType.addEventListener('change', (e) => {
                currentView = e.target.value;
                renderView();
            });
            
            // Event listeners para mudanças de período
            timeRangeSelect.addEventListener('change', (e) => {
                timeRange = e.target.value;
                renderView();
            });
            
            // Event listeners para tabs
            tabElements.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabElements.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentView = tab.dataset.tab;
                    viewType.value = currentView;
                    renderView();
                });
            });
            
            // Event listener para tooltip
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseout', () => {
                canvasTooltip.style.display = 'none';
            });
            
            // Renderizar visão inicial
            renderOverview();
        });
        
        // Função para redimensionar o canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            renderView();
        }
        
        // Função para exibir notificações
        function showNotification(message, type = 'success', duration = 3000) {
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // Função para processar seleção de arquivo
        function handleFileSelect(type) {
            return function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Atualizar nome do arquivo
                const fileNameElement = document.getElementById(`fileName${type.charAt(0).toUpperCase() + type.slice(1)}`);
                fileNameElement.textContent = file.name;
                
                // Mostrar indicador de carregamento
                loadingIndicator.style.display = 'block';
                
                // Processar arquivo
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Processar dados com base no tipo de arquivo
                        switch(type) {
                            case 'clients':
                                processClientData(workbook);
                                break;
                            case 'fluxo':
                                processFluxoData(workbook);
                                break;
                            case 'funil':
                                processFunilData(workbook);
                                break;
                        }
                        
                        // Atualizar status
                        updateDataStatus();
                        showNotification(`Arquivo ${file.name} carregado com sucesso!`);
                        
                        // Renderizar visão atualizada
                        renderView();
                    } catch (error) {
                        console.error(`Erro ao processar ${type} `, error);
                        showNotification(`Erro ao processar o arquivo: ${error.message}`, 'error');
                    } finally {
                        loadingIndicator.style.display = 'none';
                    }
                };
                
                reader.onerror = function(error) {
                    console.error(`Erro ao ler ${type} file:`, error);
                    showNotification(`Erro ao ler o arquivo`, 'error');
                    loadingIndicator.style.display = 'none';
                };
                
                reader.readAsArrayBuffer(file);
            };
        }
        
        // Funções para processar dados de cada arquivo
        function processClientData(workbook) {
            // Encontrar a aba relevante (clientes_ativos)
            const sheetName = workbook.SheetNames.find(name => 
                name.toLowerCase().includes('clientes_ativos') || 
                name.toLowerCase().includes('clientes') ||
                name.toLowerCase().includes('tecno')
            );
            
            if (!sheetName) {
                throw new Error('Aba de clientes não encontrada no arquivo');
            }
            
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // Filtrar dados válidos (remover linhas HTML/JS)
            clientData = jsonData.filter(row => {
                return row.Código && 
                       typeof row.Código !== 'object' && 
                       !String(row.Código).includes('<') && 
                       !String(row.Código).includes('>');
            });
            
            // Processar dados para padronização
            clientData = clientData.map(client => {
                // Padronizar nomes das colunas
                const standardized = {};
                
                for (const [key, value] of Object.entries(client)) {
                    const lowerKey = key.toLowerCase();
                    
                    if (lowerKey.includes('codigo') || lowerKey.includes('código')) {
                        standardized.codigo = value;
                    } else if (lowerKey.includes('cliente') || lowerKey.includes('nome')) {
                        standardized.cliente = value;
                    } else if (lowerKey.includes('status')) {
                        standardized.status_cliente = value;
                    } else if (lowerKey.includes('email')) {
                        standardized.email = value;
                    } else if (lowerKey.includes('contato') || lowerKey.includes('telefone')) {
                        standardized.telefone = value;
                    } else if (lowerKey.includes('cpf')) {
                        standardized.cpf = value;
                    } else if (lowerKey.includes('inicio') || lowerKey.includes('desde')) {
                        standardized.cliente_desde = value;
                    } else if (lowerKey.includes('contrato')) {
                        standardized.contrato = value;
                    } else if (lowerKey.includes('vencimento')) {
                        standardized.vencimento = value;
                    } else if (lowerKey.includes('bloqueio')) {
                        standardized.data_bloqueio = value;
                    }
                }
                
                // Garantir que todos os campos necessários existam
                standardized.codigo = standardized.codigo || 'N/A';
                standardized.cliente = standardized.cliente || 'N/A';
                standardized.status_cliente = standardized.status_cliente || 'Ativo';
                standardized.email = standardized.email || 'N/A';
                standardized.telefone = standardized.telefone || 'N/A';
                standardized.cpf = standardized.cpf || 'N/A';
                standardized.cliente_desde = standardized.cliente_desde || 'N/A';
                standardized.contrato = standardized.contrato || 'N/A';
                standardized.vencimento = standardized.vencimento || 'N/A';
                
                return standardized;
            });
            
            // Atualizar estatísticas
            updateStats();
        }
        
        function processFluxoData(workbook) {
            // Encontrar a aba relevante (caixa_sintetico ou similar)
            const sheetName = workbook.SheetNames.find(name => 
                name.toLowerCase().includes('caixa_sintetico') || 
                name.toLowerCase().includes('fluxo') ||
                name.toLowerCase().includes('receb') ||
                name.toLowerCase().includes('recibo')
            );
            
            if (!sheetName) {
                throw new Error('Aba de fluxo de caixa não encontrada no arquivo');
            }
            
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // Filtrar dados válidos (remover linhas HTML/JS)
            const filteredData = jsonData.filter(row => {
                return row.Código && 
                       typeof row.Código !== 'object' && 
                       !String(row.Código).includes('<') && 
                       !String(row.Código).includes('>');
            });
            
            revenueData = filteredData.map(transaction => {
                // Padronizar nomes das colunas
                const standardized = {};
                
                for (const [key, value] of Object.entries(transaction)) {
                    const lowerKey = key.toLowerCase();
                    
                    if (lowerKey.includes('codigo') || lowerKey.includes('código')) {
                        standardized.codigo = value;
                    } else if (lowerKey.includes('cliente')) {
                        standardized.cliente = value;
                    } else if (lowerKey.includes('status')) {
                        standardized.status = value;
                    } else if (lowerKey.includes('tipo')) {
                        standardized.tipo = value;
                    } else if (lowerKey.includes('item') || lowerKey.includes('descrição')) {
                        standardized.item = value;
                    } else if (lowerKey.includes('quantidade')) {
                        standardized.quantidade = value;
                    } else if (lowerKey.includes('unitario') || lowerKey.includes('preço')) {
                        standardized.valor_unitario = parseCurrency(value);
                    } else if (lowerKey.includes('total')) {
                        standardized.valor_total = parseCurrency(value);
                    } else if (lowerKey.includes('recibo')) {
                        standardized.recibo = value;
                    } else if (lowerKey.includes('consultor') || lowerKey.includes('vendedor')) {
                        standardized.consultor = value;
                    } else if (lowerKey.includes('desconto')) {
                        standardized.valor_desconto = parseCurrency(value);
                    } else if (lowerKey.includes('pagamento') || lowerKey.includes('forma')) {
                        standardized.forma_pagamento = value;
                    } else if (lowerKey.includes('data') && (lowerKey.includes('recibo') || lowerKey.includes('vencimento'))) {
                        standardized.data_recibo = value;
                    }
                }
                
                // Garantir que todos os campos necessários existam
                standardized.codigo = standardized.codigo || 'N/A';
                standardized.cliente = standardized.cliente || 'N/A';
                standardized.status = standardized.status || 'Ativo';
                standardized.tipo = standardized.tipo || 'Contrato';
                standardized.item = standardized.item || 'N/A';
                standardized.quantidade = standardized.quantidade || 1;
                standardized.valor_unitario = standardized.valor_unitario || 0;
                standardized.valor_total = standardized.valor_total || 0;
                standardized.recibo = standardized.recibo || 'N/A';
                standardized.consultor = standardized.consultor || 'N/A';
                standardized.valor_desconto = standardized.valor_desconto || 0;
                standardized.forma_pagamento = standardized.forma_pagamento || 'N/A';
                standardized.data_recibo = standardized.data_recibo || 'N/A';
                
                return standardized;
            });
            
            // Atualizar estatísticas
            updateStats();
        }
        
        function processFunilData(workbook) {
            // Encontrar a aba relevante (vendas_totais ou similar)
            const sheetName = workbook.SheetNames.find(name => 
                name.toLowerCase().includes('vendas_totais') || 
                name.toLowerCase().includes('funil') ||
                name.toLowerCase().includes('oportunidades') ||
                name.toLowerCase().includes('recibo')
            );
            
            if (!sheetName) {
                throw new Error('Aba de funil de vendas não encontrada no arquivo');
            }
            
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // Filtrar dados válidos (remover linhas HTML/JS)
            const filteredData = jsonData.filter(row => {
                return row.Código && 
                       typeof row.Código !== 'object' && 
                       !String(row.Código).includes('<') && 
                       !String(row.Código).includes('>');
            });
            
            salesFunnelData = filteredData.map(opportunity => {
                // Padronizar nomes das colunas
                const standardized = {};
                
                for (const [key, value] of Object.entries(opportunity)) {
                    const lowerKey = key.toLowerCase();
                    
                    if (lowerKey.includes('codigo') || lowerKey.includes('código')) {
                        standardized.codigo = value;
                    } else if (lowerKey.includes('cliente')) {
                        standardized.cliente = value;
                    } else if (lowerKey.includes('status')) {
                        standardized.status = value;
                    } else if (lowerKey.includes('recibo')) {
                        standardized.recibo = value;
                    } else if (lowerKey.includes('descricao') || lowerKey.includes('descrição')) {
                        standardized.descricao = value;
                    } else if (lowerKey.includes('valor')) {
                        standardized.valor = parseCurrency(value);
                    } else if (lowerKey.includes('pagamento') || lowerKey.includes('forma')) {
                        standardized.forma_pagamento = value;
                    } else if (lowerKey.includes('data')) {
                        standardized.data = value;
                    } else if (lowerKey.includes('origem')) {
                        standardized.origem = value;
                    } else if (lowerKey.includes('responsavel') || lowerKey.includes('consultor')) {
                        standardized.consultor = value;
                    }
                }
                
                // Garantir que todos os campos necessários existam
                standardized.codigo = standardized.codigo || 'N/A';
                standardized.cliente = standardized.cliente || 'N/A';
                standardized.status = standardized.status || 'Ativo';
                standardized.recibo = standardized.recibo || 'N/A';
                standardized.descricao = standardized.descricao || 'N/A';
                standardized.valor = standardized.valor || 0;
                standardized.forma_pagamento = standardized.forma_pagamento || 'N/A';
                standardized.data = standardized.data || 'N/A';
                standardized.origem = standardized.origem || 'N/A';
                standardized.consultor = standardized.consultor || 'N/A';
                
                return standardized;
            });
            
            // Atualizar estatísticas
            updateStats();
        }
        
        // Função auxiliar para parsear valores monetários
        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            
            // Remover caracteres não numéricos, exceto vírgula e ponto
            let cleaned = String(value).replace(/[^\d.,]/g, '');
            
            // Determinar se é vírgula ou ponto como separador decimal
            const hasComma = cleaned.includes(',');
            const hasDot = cleaned.includes('.');
            
            // Se houver ambos, assumir que o último é o separador decimal
            if (hasComma && hasDot) {
                if (cleaned.lastIndexOf(',') > cleaned.lastIndexOf('.')) {
                    cleaned = cleaned.replace(/\./g, '').replace(',', '.');
                } else {
                    cleaned = cleaned.replace(/,/g, '').replace('.', ',');
                }
            } else if (hasComma) {
                cleaned = cleaned.replace(/,/g, '.');
            }
            
            // Converter para número
            return parseFloat(cleaned) || 0;
        }
        
        // Função para atualizar status de dados
        function updateDataStatus() {
            let status = [];
            if (clientData) status.push('Clientes');
            if (revenueData) status.push('Fluxo de Caixa');
            if (salesFunnelData) status.push('Funil de Vendas');
            
            document.getElementById('dataStatus').textContent = 
                status.length > 0 ? status.join(', ') : 'Nenhum arquivo';
                
            document.getElementById('lastUpdate').textContent = 
                new Date().toLocaleString();
        }
        
        // Função para atualizar estatísticas
        function updateStats() {
            // Clientes ativos
            const activeClients = clientData ? 
                clientData.filter(c => c.status_cliente && 
                    c.status_cliente.toLowerCase().includes('ativo')).length : 0;
            document.getElementById('active-clients').textContent = activeClients;
            
            // Contratos ativos
            const activeContracts = salesFunnelData ? 
                salesFunnelData.filter(c => c.status && 
                    c.status.toLowerCase().includes('ativo')).length : 0;
            document.getElementById('active-contracts').textContent = activeContracts;
            
            // Receita mensal
            let monthlyRevenue = 0;
            if (revenueData) {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                monthlyRevenue = revenueData
                    .filter(t => {
                        const date = parseDate(t.data_recibo);
                        return date && 
                            date.getMonth() === currentMonth &&
                            date.getFullYear() === currentYear;
                    })
                    .reduce((sum, t) => sum + (t.valor_total || 0), 0);
            }
            document.getElementById('monthly-revenue').textContent = 
                `R$ ${monthlyRevenue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
            
            // Taxa de churn
            let churnRate = 0;
            if (clientData) {
                const totalClients = clientData.length;
                const churnedClients = clientData.filter(c => 
                    c.status_cliente && 
                    (c.status_cliente.toLowerCase().includes('cancelado') || 
                     c.status_cliente.toLowerCase().includes('bloqueado'))
                ).length;
                
                churnRate = totalClients > 0 ? (churnedClients / totalClients * 100) : 0;
            }
            document.getElementById('churn-rate').textContent = `${churnRate.toFixed(1)}%`;
        }
        
        // Função para parsear datas
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Se já for um objeto Date
            if (dateStr instanceof Date) return dateStr;
            
            // Remover hora se presente
            const dateOnly = String(dateStr).split(' ')[0];
            
            // Testar diferentes formatos
            const formats = [
                /\d{2}\/\d{2}\/\d{4}/,    // dd/mm/yyyy
                /\d{4}-\d{2}-\d{2}/,      // yyyy-mm-dd
                /\d{2}-\d{2}-\d{4}/       // dd-mm-yyyy
            ];
            
            for (const format of formats) {
                if (format.test(dateOnly)) {
                    const parts = dateOnly.split(/[\-\/]/);
                    
                    if (parts.length === 3) {
                        // dd/mm/yyyy ou dd-mm-yyyy
                        if (format === formats[0] || format === formats[2]) {
                            return new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                        // yyyy-mm-dd
                        else {
                            return new Date(parts[0], parts[1] - 1, parts[2]);
                        }
                    }
                }
            }
            
            // Tentar criar diretamente
            const date = new Date(dateStr);
            return isNaN(date) ? null : date;
        }
        
        // Função para busca de clientes
        function performSearch() {
            const query = searchQuery.value.trim().toLowerCase();
            if (!query || (!clientData && !revenueData && !salesFunnelData)) {
                renderView();
                return;
            }
            
            // Filtrar dados
            let filteredClients = [];
            
            if (clientData) {
                filteredClients = clientData.filter(client => 
                    String(client.codigo).toLowerCase().includes(query) ||
                    client.cliente.toLowerCase().includes(query) ||
                    (client.cpf && client.cpf.toLowerCase().includes(query)) ||
                    (client.telefone && client.telefone.toLowerCase().includes(query))
                );
            }
            
            // Renderizar resultados
            renderClientSearchResults(filteredClients);
        }
        
        // Função para renderizar visão atual
        function renderView() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            switch(currentView) {
                case 'overview':
                    renderOverview();
                    break;
                case 'clients':
                    renderClientView();
                    break;
                case 'contracts':
                    renderContractsView();
                    break;
                case 'revenue':
                    renderRevenueView();
                    break;
                case 'churn':
                    renderChurnAnalysis();
                    break;
                default:
                    renderOverview();
            }
        }
        
        // Funções de renderização específicas
        function renderOverview() {
            // Título
            drawText("Visão Geral do Negócio", 20, 40, 24, '#1e40af', 'bold');
            
            // Seção de clientes
            drawSectionTitle("Clientes", 20, 70);
            drawCard(20, 100, canvas.width / 2 - 30, 150, 
                `Total de Clientes: ${clientData ? clientData.length : 'N/A'}`,
                clientData ? clientData.filter(c => c.status_cliente && c.status_cliente.toLowerCase().includes('ativo')).length + ' ativos' : '',
                '#1e40af'
            );
            
            // Seção de contratos
            drawSectionTitle("Contratos", canvas.width / 2 + 10, 70);
            drawCard(canvas.width / 2 + 10, 100, canvas.width / 2 - 30, 150, 
                `Total de Contratos: ${salesFunnelData ? salesFunnelData.length : 'N/A'}`,
                salesFunnelData ? salesFunnelData.filter(c => c.status && c.status.toLowerCase().includes('ativo')).length + ' ativos' : '',
                '#16a34a'
            );
            
            // Seção de receita
            drawSectionTitle("Receita", 20, 270);
            drawCard(20, 300, canvas.width / 2 - 30, 150, 
                `Receita Mensal: R$ ${revenueData ? 
                    revenueData.reduce((sum, t) => sum + (t.valor_total || 0), 0).toFixed(2) : '0.00'}`,
                revenueData ? 
                    `${revenueData.filter(t => t.forma_pagamento && t.forma_pagamento.toLowerCase().includes('pix')).length} transações por PIX` : '',
                '#d97706'
            );
            
            // Seção de churn
            drawSectionTitle("Análise de Churn", canvas.width / 2 + 10, 270);
            drawCard(canvas.width / 2 + 10, 300, canvas.width / 2 - 30, 150, 
                `Taxa de Churn: ${clientData ? 
                    (clientData.filter(c => c.status_cliente && 
                    (c.status_cliente.toLowerCase().includes('cancelado') || 
                     c.status_cliente.toLowerCase().includes('bloqueado'))).length / 
                    clientData.length * 100).toFixed(1) : '0.0'}%`,
                clientData ? 
                    `${clientData.filter(c => c.status_cliente && c.status_cliente.toLowerCase().includes('bloqueado')).length} clientes bloqueados` : '',
                '#dc2626'
            );
            
            // Funil de vendas
            drawSectionTitle("Funil de Vendas", 20, 470);
            if (salesFunnelData) {
                renderSalesFunnel(20, 500, canvas.width - 40, 150);
            } else {
                drawText("Carregue o arquivo de funil de vendas para visualizar o funil", 
                        40, 550, 16, '#64748b');
            }
        }
        
        function renderClientView() {
            drawText("Análise de Clientes", 20, 40, 24, '#1e40af', 'bold');
            
            // Status por tipo
            if (clientData) {
                const statusCounts = {};
                clientData.forEach(client => {
                    const status = client.status_cliente || 'Desconhecido';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                
                drawSectionTitle("Distribuição por Status", 20, 70);
                renderPieChart(20, 100, 300, 300, statusCounts, 
                    ['#10b981', '#f59e0b', '#ef4444', '#6366f1']);
                
                // Legenda
                let legendY = 120;
                Object.keys(statusCounts).forEach((status, index) => {
                    ctx.fillStyle = ['#10b981', '#f59e0b', '#ef4444', '#6366f1'][index];
                    ctx.fillRect(340, legendY, 15, 15);
                    ctx.fillStyle = '#1e293b';
                    ctx.font = '14px Arial';
                    ctx.fillText(`${status} (${statusCounts[status]})`, 365, legendY + 12);
                    legendY += 30;
                });
                
                // Tabela de clientes
                drawSectionTitle("Clientes Recentes", 400, 70);
                renderClientTable(400, 100, canvas.width - 420, 350);
            } else {
                drawText("Carregue o arquivo de clientes para visualizar a análise", 
                        20, 100, 18, '#64748b');
            }
        }
        
        function renderContractsView() {
            drawText("Análise de Contratos", 20, 40, 24, '#1e40af', 'bold');
            
            // Tipos de contratos
            if (salesFunnelData) {
                const contractTypes = {};
                salesFunnelData.forEach(contract => {
                    const tipo = contract.descricao || 'Desconhecido';
                    // Extrair apenas o tipo básico do contrato
                    const tipoSimplificado = tipo.includes('CALISTENIA') ? 'CALISTENIA' :
                                           tipo.includes('GYMPASS') ? 'GYMPASS' :
                                           tipo.includes('FISIOTERAPIA') ? 'FISIOTERAPIA' :
                                           'OUTROS';
                    contractTypes[tipoSimplificado] = (contractTypes[tipoSimplificado] || 0) + 1;
                });
                
                drawSectionTitle("Tipos de Contratos", 20, 70);
                renderPieChart(20, 100, 300, 300, contractTypes, 
                    ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b']);
                
                // Legenda
                let legendY = 120;
                Object.keys(contractTypes).forEach((tipo, index) => {
                    ctx.fillStyle = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b'][index];
                    ctx.fillRect(340, legendY, 15, 15);
                    ctx.fillStyle = '#1e293b';
                    ctx.font = '14px Arial';
                    ctx.fillText(`${tipo} (${contractTypes[tipo]})`, 365, legendY + 12);
                    legendY += 30;
                });
                
                // Contratos por período
                drawSectionTitle("Contratos por Período", 400, 70);
                renderContractTrend(400, 100, canvas.width - 420, 300);
            } else {
                drawText("Carregue o arquivo de funil de vendas para visualizar a análise de contratos", 
                        20, 100, 18, '#64748b');
            }
        }
        
        function renderRevenueView() {
            drawText("Análise de Receita", 20, 40, 24, '#1e40af', 'bold');
            
            // Receita por mês
            if (revenueData) {
                const monthlyRevenue = {};
                revenueData.forEach(transaction => {
                    const date = parseDate(transaction.data_recibo);
                    if (date) {
                        const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                        monthlyRevenue[monthKey] = (monthlyRevenue[monthKey] || 0) + (transaction.valor_total || 0);
                    }
                });
                
                // Ordenar por data
                const sortedMonths = Object.keys(monthlyRevenue).sort();
                const revenueValues = sortedMonths.map(month => monthlyRevenue[month]);
                
                drawSectionTitle("Receita Mensal", 20, 70);
                renderBarChart(20, 100, canvas.width - 40, 300, 
                    sortedMonths.map(month => {
                        const [year, monthNum] = month.split('-');
                        return `${getMonthName(parseInt(monthNum))}/${year.substring(2)}`;
                    }), 
                    revenueValues, 
                    '#3b82f6');
                
                // Formas de pagamento
                drawSectionTitle("Formas de Pagamento", 20, 420);
                const paymentMethods = {};
                revenueData.forEach(transaction => {
                    const method = transaction.forma_pagamento || 'Desconhecido';
                    paymentMethods[method] = (paymentMethods[method] || 0) + 1;
                });
                
                renderPieChart(20, 450, 300, 250, paymentMethods, 
                    ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444']);
                
                // Legenda
                let legendY = 470;
                Object.keys(paymentMethods).slice(0, 5).forEach((method, index) => {
                    ctx.fillStyle = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'][index];
                    ctx.fillRect(340, legendY, 15, 15);
                    ctx.fillStyle = '#1e293b';
                    ctx.font = '14px Arial';
                    ctx.fillText(`${method} (${paymentMethods[method]})`, 365, legendY + 12);
                    legendY += 30;
                });
            } else {
                drawText("Carregue o arquivo de fluxo de caixa para visualizar a análise de receita", 
                        20, 100, 18, '#64748b');
            }
        }
        
        function renderChurnAnalysis() {
            drawText("Análise de Churn", 20, 40, 24, '#1e40af', 'bold');
            
            if (clientData) {
                // Churn por tempo de contrato
                const churnByDuration = {
                    '< 1 mês': 0,
                    '1-3 meses': 0,
                    '3-6 meses': 0,
                    '6-12 meses': 0,
                    '> 12 meses': 0
                };
                
                clientData.forEach(client => {
                    if (client.status_cliente && 
                        (client.status_cliente.toLowerCase().includes('cancelado') || 
                         client.status_cliente.toLowerCase().includes('bloqueado'))) {
                        
                        // Aqui precisaríamos de dados mais detalhados para calcular a duração real
                        // Como não temos esses dados no exemplo, vamos simular
                        const randomDuration = Math.random();
                        if (randomDuration < 0.3) churnByDuration['< 1 mês']++;
                        else if (randomDuration < 0.6) churnByDuration['1-3 meses']++;
                        else if (randomDuration < 0.8) churnByDuration['3-6 meses']++;
                        else if (randomDuration < 0.95) churnByDuration['6-12 meses']++;
                        else churnByDuration['> 12 meses']++;
                    }
                });
                
                drawSectionTitle("Churn por Tempo de Contrato", 20, 70);
                renderBarChart(20, 100, canvas.width / 2 - 30, 300, 
                    Object.keys(churnByDuration), 
                    Object.values(churnByDuration), 
                    '#ef4444');
                
                // Churn por motivo (simulado)
                drawSectionTitle("Principais Motivos de Churn", 400, 70);
                const churnReasons = {
                    "Baixa frequência": 35,
                    "Problemas financeiros": 25,
                    "Mudança de cidade": 15,
                    "Insatisfação com serviços": 20,
                    "Outros": 5
                };
                
                renderPieChart(400, 100, 300, 300, churnReasons, 
                    ['#ef4444', '#f59e0b', '#6366f1', '#10b981', '#64748b']);
                
                // Legenda
                let legendY = 120;
                Object.keys(churnReasons).forEach((reason, index) => {
                    ctx.fillStyle = ['#ef4444', '#f59e0b', '#6366f1', '#10b981', '#64748b'][index];
                    ctx.fillRect(720, legendY, 15, 15);
                    ctx.fillStyle = '#1e293b';
                    ctx.font = '14px Arial';
                    ctx.fillText(`${reason} (${churnReasons[reason]}%)`, 745, legendY + 12);
                    legendY += 30;
                });
                
                // Recomendações
                drawSectionTitle("Recomendações Estratégicas", 20, 420);
                drawCard(20, 450, canvas.width - 40, 150, 
                    "Programa de Retenção para Clientes com Baixa Frequência",
                    "Implementar check-ins semanais para membros com frequência < 2x/semana",
                    '#1e40af');
                
                drawCard(20, 620, canvas.width - 40, 150, 
                    "Ofertas Especiais para Período Crítico",
                    "Criar programa especial para clientes nos primeiros 3 meses (período com maior churn)",
                    '#1e40af');
            } else {
                drawText("Carregue o arquivo de clientes para visualizar a análise de churn", 
                        20, 100, 18, '#64748b');
            }
        }
        
        function renderClientSearchResults(clients) {
            drawText(`Resultados da Busca (${clients.length} encontrados)`, 20, 40, 24, '#1e40af', 'bold');
            
            if (clients.length === 0) {
                drawText("Nenhum cliente encontrado com os critérios especificados.", 
                        20, 80, 18, '#64748b');
                return;
            }
            
            // Tabela de resultados
            const headers = ["Código", "Cliente", "Status", "Contrato", "Vencimento", "Telefone"];
            const rowHeight = 30;
            const headerHeight = 40;
            
            // Desenhar cabeçalho
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(20, 70, canvas.width - 40, headerHeight);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            headers.forEach((header, i) => {
                const x = 30 + i * (canvas.width - 60) / headers.length;
                drawText(header, x, 95, 14, 'white', 'bold');
            });
            
            // Desenhar linhas de dados
            clients.slice(0, 15).forEach((client, rowIndex) => {
                const y = 110 + rowIndex * rowHeight;
                
                // Alternar cores de linha
                if (rowIndex % 2 === 0) {
                    ctx.fillStyle = '#f8fafc';
                    ctx.fillRect(20, y - 5, canvas.width - 40, rowHeight);
                }
                
                // Desenhar dados
                ctx.fillStyle = '#1e293b';
                ctx.font = '14px Arial';
                
                const rowData = [
                    client.codigo,
                    client.cliente,
                    client.status_cliente,
                    client.contrato,
                    client.vencimento,
                    client.telefone
                ];
                
                rowData.forEach((cell, colIndex) => {
                    const x = 30 + colIndex * (canvas.width - 60) / headers.length;
                    drawText(String(cell || 'N/A'), x, y + 10, 14, '#1e293b');
                });
                
                // Linha divisória
                ctx.strokeStyle = '#e2e8f0';
                ctx.beginPath();
                ctx.moveTo(20, y + rowHeight - 5);
                ctx.lineTo(canvas.width - 20, y + rowHeight - 5);
                ctx.stroke();
            });
            
            // Mensagem se houver mais resultados
            if (clients.length > 15) {
                drawText(`Mostrando 15 de ${clients.length} resultados. Refine sua busca para ver mais.`, 
                        20, 110 + 15 * rowHeight, 14, '#64748b');
            }
        }
        
        // Funções auxiliares de renderização
        function drawText(text, x, y, fontSize, color, fontWeight = 'normal') {
            ctx.font = `${fontWeight} ${fontSize}px Arial`;
            ctx.fillStyle = color;
            ctx.textAlign = 'left';
            ctx.fillText(text, x, y);
        }
        
        function drawSectionTitle(title, x, y) {
            ctx.fillStyle = '#1e40af';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(title, x, y);
            
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y + 5);
            ctx.lineTo(x + ctx.measureText(title).width, y + 5);
            ctx.stroke();
        }
        
        function drawCard(x, y, width, height, title, subtitle, color) {
            // Sombra
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 5;
            
            // Card
            ctx.fillStyle = 'white';
            ctx.roundRect(x, y, width, height, 10);
            ctx.fill();
            
            // Resetar sombra
            ctx.shadowColor = 'transparent';
            
            // Linha superior colorida
            ctx.fillStyle = color;
            ctx.fillRect(x, y, width, 5);
            
            // Conteúdo
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(title, x + 15, y + 40);
            
            ctx.font = '14px Arial';
            ctx.fillStyle = '#64748b';
            ctx.fillText(subtitle, x + 15, y + 65);
        }
        
        function renderPieChart(x, y, width, height, data, colors) {
            const centerX = x + width / 2;
            const centerY = y + height / 2;
            const radius = Math.min(width, height) / 2 - 20;
            
            let total = 0;
            for (const value of Object.values(data)) {
                total += value;
            }
            
            let startAngle = 0;
            let index = 0;
            
            for (const [label, value] of Object.entries(data)) {
                const sliceAngle = (value / total) * 2 * Math.PI;
                
                // Desenhar fatia
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                
                // Desenhar borda
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                startAngle += sliceAngle;
                index++;
            }
        }
        
        function renderBarChart(x, y, width, height, labels, values, color) {
            const padding = 60;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - padding - 20;
            
            // Eixo X
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x + padding, y + chartHeight);
            ctx.lineTo(x + width - padding, y + chartHeight);
            ctx.stroke();
            
            // Eixo Y
            ctx.beginPath();
            ctx.moveTo(x + padding, y);
            ctx.lineTo(x + padding, y + chartHeight);
            ctx.stroke();
            
            // Valores no eixo Y
            const maxValue = Math.max(...values);
            const step = maxValue > 0 ? Math.ceil(maxValue / 5) : 1;
            
            for (let i = 0; i <= 5; i++) {
                const value = i * step;
                const yPos = y + chartHeight - (value / maxValue) * chartHeight;
                
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Arial';
                ctx.fillText(`R$ ${value.toFixed(0)}`, x + padding - 40, yPos + 5);
                
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x + padding, yPos);
                ctx.lineTo(x + width - padding, yPos);
                ctx.stroke();
            }
            
            // Barras
            const barWidth = (chartWidth / labels.length) * 0.7;
            const gap = (chartWidth / labels.length) * 0.3;
            
            for (let i = 0; i < labels.length; i++) {
                const barHeight = (values[i] / maxValue) * chartHeight;
                const xPos = x + padding + i * (barWidth + gap);
                const yPos = y + chartHeight - barHeight;
                
                // Sombra da barra
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(xPos, y + chartHeight - barHeight - 2, barWidth, barHeight + 2);
                
                // Barra
                ctx.fillStyle = color;
                ctx.fillRect(xPos, yPos, barWidth, barHeight);
                
                // Rótulo X
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(labels[i], xPos + barWidth / 2, y + chartHeight + 15);
            }
        }
        
        function renderSalesFunnel(x, y, width, height) {
            const stages = [
                { name: "Leads", value: 500 },
                { name: "Contato Inicial", value: 350 },
                { name: "Aula Experimental", value: 200 },
                { name: "Vendas Concluídas", value: 120 },
                { name: "Clientes Ativos", value: 100 }
            ];
            
            const funnelHeight = height - 40;
            const maxWidth = width * 0.8;
            
            // Calcular a altura de cada estágio
            const stageHeight = funnelHeight / stages.length;
            
            // Desenhar funil
            for (let i = 0; i < stages.length; i++) {
                const stage = stages[i];
                const percentage = stage.value / stages[0].value;
                const currentWidth = maxWidth * percentage;
                const xPos = x + (width - currentWidth) / 2;
                const yPos = y + i * stageHeight;
                
                // Área do estágio
                ctx.fillStyle = i === stages.length - 1 ? '#10b981' : 
                               i === stages.length - 2 ? '#10b981' : 
                               i === stages.length - 3 ? '#f59e0b' : 
                               '#ef4444';
                ctx.globalAlpha = 0.8;
                ctx.fillRect(xPos, yPos, currentWidth, stageHeight);
                ctx.globalAlpha = 1.0;
                
                // Borda
                ctx.strokeStyle = '#94a3b8';
                ctx.lineWidth = 1;
                ctx.strokeRect(xPos, yPos, currentWidth, stageHeight);
                
                // Texto
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(stage.name, x + width / 2, yPos + stageHeight / 2 - 10);
                
                ctx.font = '16px Arial';
                ctx.fillText(stage.value, x + width / 2, yPos + stageHeight / 2 + 10);
                
                // Taxa de conversão
                if (i > 0) {
                    const conversionRate = ((stage.value / stages[i-1].value) * 100).toFixed(1);
                    ctx.fillStyle = '#64748b';
                    ctx.font = '12px Arial';
                    ctx.fillText(`${conversionRate}%`, xPos + currentWidth + 10, yPos + stageHeight / 2);
                }
            }
            
            // Legenda
            ctx.fillStyle = '#1e293b';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            drawText("Cor do Funil:", x, y + height - 30, 14, '#1e293b');
            ctx.fillStyle = '#10b981';
            ctx.fillRect(x + 80, y + height - 35, 15, 15);
            ctx.fillStyle = '#1e293b';
            ctx.fillText("Estágios de Retenção", x + 100, y + height - 20);
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(x + 250, y + height - 35, 15, 15);
            ctx.fillStyle = '#1e293b';
            ctx.fillText("Estágios Intermediários", x + 270, y + height - 20);
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(x + 450, y + height - 35, 15, 15);
            ctx.fillStyle = '#1e293b';
            ctx.fillText("Estágios Iniciais", x + 470, y + height - 20);
        }
        
        function renderContractTrend(x, y, width, height) {
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const newContracts = months.map(() => Math.floor(Math.random() * 20) + 5);
            const renewals = months.map(() => Math.floor(Math.random() * 10) + 3);
            
            const padding = 60;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - padding - 20;
            
            // Eixo X
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x + padding, y + chartHeight);
            ctx.lineTo(x + width - padding, y + chartHeight);
            ctx.stroke();
            
            // Eixo Y
            ctx.beginPath();
            ctx.moveTo(x + padding, y);
            ctx.lineTo(x + padding, y + chartHeight);
            ctx.stroke();
            
            // Valores no eixo Y
            const maxValue = Math.max(...newContracts, ...renewals) + 5;
            
            for (let i = 0; i <= 5; i++) {
                const value = i * (maxValue / 5);
                const yPos = y + chartHeight - (value / maxValue) * chartHeight;
                
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Arial';
                ctx.fillText(Math.round(value), x + padding - 30, yPos + 5);
                
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x + padding, yPos);
                ctx.lineTo(x + width - padding, yPos);
                ctx.stroke();
            }
            
            // Barras
            const barGroupWidth = (chartWidth / months.length) * 0.8;
            const barWidth = barGroupWidth / 2.5;
            
            for (let i = 0; i < months.length; i++) {
                const xPos = x + padding + i * (chartWidth / months.length) + barWidth / 2;
                
                // Novos contratos
                const newHeight = (newContracts[i] / maxValue) * chartHeight;
                const newPosY = y + chartHeight - newHeight;
                
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(xPos, newPosY, barWidth, newHeight);
                
                // Renovações
                const renewalHeight = (renewals[i] / maxValue) * chartHeight;
                const renewalPosY = y + chartHeight - renewalHeight;
                
                ctx.fillStyle = '#8b5cf6';
                ctx.fillRect(xPos + barWidth, renewalPosY, barWidth, renewalHeight);
                
                // Rótulo X
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(months[i], xPos + barWidth / 2, y + chartHeight + 15);
            }
            
            // Legenda
            ctx.fillStyle = '#1e293b';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            
            // Novos contratos
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(x + 20, y + 20, 15, 15);
            ctx.fillStyle = '#1e293b';
            ctx.fillText("Novos Contratos", x + 40, y + 33);
            
            // Renovações
            ctx.fillStyle = '#8b5cf6';
            ctx.fillRect(x + 180, y + 20, 15, 15);
            ctx.fillStyle = '#1e293b';
            ctx.fillText("Renovações", x + 200, y + 33);
        }
        
        function renderClientTable(x, y, width, height) {
            if (!clientData) return;
            
            const headers = ["Código", "Cliente", "Status", "Contrato", "Vencimento"];
            const rowHeight = 30;
            const headerHeight = 40;
            
            // Desenhar cabeçalho
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(x, y, width, headerHeight);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            headers.forEach((header, i) => {
                const colWidth = width / headers.length;
                const xPos = x + i * colWidth + colWidth / 2;
                ctx.textAlign = 'center';
                ctx.fillText(header, xPos, y + 25);
            });
            
            // Desenhar linhas de dados
            const clientsToShow = clientData.slice(0, 8);
            clientsToShow.forEach((client, rowIndex) => {
                const yPos = y + headerHeight + rowIndex * rowHeight;
                
                // Alternar cores de linha
                if (rowIndex % 2 === 0) {
                    ctx.fillStyle = '#f8fafc';
                    ctx.fillRect(x, yPos, width, rowHeight);
                }
                
                // Desenhar dados
                ctx.fillStyle = '#1e293b';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                
                const rowData = [
                    client.codigo,
                    client.cliente,
                    client.status_cliente,
                    client.contrato,
                    client.vencimento
                ];
                
                rowData.forEach((cell, colIndex) => {
                    const colWidth = width / headers.length;
                    const xPos = x + colIndex * colWidth + 10;
                    drawText(String(cell || 'N/A'), xPos, yPos + 20, 14, '#1e293b');
                });
                
                // Linha divisória
                ctx.strokeStyle = '#e2e8f0';
                ctx.beginPath();
                ctx.moveTo(x, yPos + rowHeight);
                ctx.lineTo(x + width, yPos + rowHeight);
                ctx.stroke();
            });
            
            // Indicador de mais registros
            if (clientData.length > 8) {
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(`Mostrando 8 de ${clientData.length} registros...`, x + width - 10, y + headerHeight + 8 * rowHeight - 10);
            }
        }
        
        function getMonthName(monthNumber) {
            const months = [
                'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
            ];
            return months[monthNumber - 1] || '';
        }
        
        // Função para manipular movimento do mouse no canvas
        function handleCanvasMouseMove(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Resetar tooltip
            canvasTooltip.style.display = 'none';
            
            // Verificar se está sobre elementos interativos
            if (currentView === 'overview') {
                // Verificar se está sobre cards
                const cardPositions = [
                    {x: 20, y: 100, w: canvas.width / 2 - 30, h: 150, title: "Clientes Ativos", content: "Visualizar detalhes de clientes"},
                    {x: canvas.width / 2 + 10, y: 100, w: canvas.width / 2 - 30, h: 150, title: "Contratos Ativos", content: "Visualizar detalhes de contratos"},
                    {x: 20, y: 300, w: canvas.width / 2 - 30, h: 150, title: "Receita Mensal", content: "Visualizar análise de receita"},
                    {x: canvas.width / 2 + 10, y: 300, w: canvas.width / 2 - 30, h: 150, title: "Taxa de Churn", content: "Visualizar análise de churn"}
                ];
                
                for (const card of cardPositions) {
                    if (x >= card.x && x <= card.x + card.w && 
                        y >= card.y && y <= card.y + card.h) {
                        showTooltip(card.title, card.content, event);
                        break;
                    }
                }
            }
        }
        
        function showTooltip(title, content, event) {
            canvasTooltip.innerHTML = `<strong>${title}</strong><br>${content}`;
            canvasTooltip.style.display = 'block';
            
            // Posicionar tooltip
            const tooltipWidth = canvasTooltip.offsetWidth;
            const tooltipHeight = canvasTooltip.offsetHeight;
            const canvasRect = canvas.getBoundingClientRect();
            const pageX = event.pageX;
            const pageY = event.pageY;
            
            let top = pageY - canvasRect.top + 15;
            let left = pageX - canvasRect.left + 15;
            
            // Ajustar para não sair da tela
            if (left + tooltipWidth > canvas.width) {
                left = canvas.width - tooltipWidth - 10;
            }
            
            if (top + tooltipHeight > canvas.height) {
                top = canvas.height - tooltipHeight - 10;
            }
            
            canvasTooltip.style.top = `${top}px`;
            canvasTooltip.style.left = `${left}px`;
        }
        
        // Extensão para desenhar retângulos arredondados
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
            if (width < 2 * radius) radius = width / 2;
            if (height < 2 * radius) radius = height / 2;
            this.beginPath();
            this.moveTo(x + radius, y);
            this.arcTo(x + width, y, x + width, y + height, radius);
            this.arcTo(x + width, y + height, x, y + height, radius);
            this.arcTo(x, y + height, x, y, radius);
            this.arcTo(x, y, x + width, y, radius);
            this.closePath();
            return this;
        };
    </script>
</body>
</html>